languages:
  ruby: 2.0.0-p353
setup:
- scripts:
  - export RAILS_ENV=test
  - echo "export RAILS_ENV=test" >> ~/.bash_profile
  #####################################
  # Remove repo to be tested
  # -----------------------------------
  # All of the repositories in the
  # project are already cloned to
  # /crunchbase/, so we want to remove
  # the one that is being tested and
  # slot in the new to-be-tested code
  # in its place.
  #####################################
  - export REPOS=(admin background_jobs cacheable cb_commons daemonizer deja graph_manager integration models moneypenny mr_clean queue_adapter review_manager riak_mapper site user_manager version_manager version_worker write_manager)
  - for i in ${REPOS[@]}; do git clone -b develop git@github.com:crunchbase/$i.git /crunchbase/$i; done
  - rm -rf /crunchbase/$KOALITY_REPOSITORY
  - mv /crunchbase/* /home/crunchbase/
  - rm -rf /crunchbase
  - sudo ln -s /home/crunchbase /crunchbase
  - sudo chown -R crunchbase:crunchbase /home/crunchbase
  - for i in ${REPOS[@]}; do cd /crunchbase/$i && if [ -e Gemfile ]; then bundle install; fi; if [ -e bower.json ]; then su crunchbase -c "bower install"; fi; done
  ####################################
  # Create and Seed the Database
  # ----------------------------------
  # For all tests, seed the database.
  ####################################
  - cd /crunchbase/integration && bundle exec rake db:create && bundle exec rake db:migrate && bundle exec rake db:symlink
test:
  machines: 1
  scripts:
  - pull request:
      path: /crunchbase/$KOALITY_REPOSITORY
      script: bundle exec rake ci_spec
      timeout: 1800
      xunit: spec/reports
#  factories:
#  - setup factory:
#      script:
      #########################################
      # Test affected repos
      # ---------------------------------------
      # Look up and test each repository that
      # depends upon the repository that is
      # being tested.
      #########################################
#      - |
#        for dir in `grep "/crunchbase/$KOALITY_REPOSITORY" /crunchbase/*/Gemfile | cut -d ':' -f 1 | sed -e "s/\/Gemfile//g"`; do
#          if [ -e $dir/Rakefile ] && grep -q "ci_spec" $dir/Rakefile
#            then
#              echo "      - `echo $dir | cut -d '/' -f 3`:"
#              echo "          path: $dir"
#              echo "          script: bundle exec rake ci_spec"
#              echo "          xunit: spec/reports"
#              echo "          timeout: 1800"
#          fi
#        done
